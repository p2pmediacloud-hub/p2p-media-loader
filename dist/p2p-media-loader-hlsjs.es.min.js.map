{"version":3,"file":"p2p-media-loader-hlsjs.es.min.js","sources":["../src/utils.ts","../src/fragment-loader.ts","../src/playlist-loader.ts","../src/segment-mananger.ts","../src/engine.ts","../src/engine-static.ts"],"sourcesContent":["import { ByteRange } from \"p2p-media-loader-core\";\n\nexport function getSegmentRuntimeId(\n  segmentRequestUrl: string,\n  byteRange?: ByteRange,\n) {\n  if (!byteRange) return segmentRequestUrl;\n  return `${segmentRequestUrl}|${byteRange.start}-${byteRange.end}`;\n}\n\nexport function getByteRange(\n  rangeStart: number | undefined,\n  rangeEnd: number | undefined,\n): ByteRange | undefined {\n  if (\n    rangeStart !== undefined &&\n    rangeEnd !== undefined &&\n    rangeStart <= rangeEnd\n  ) {\n    return { start: rangeStart, end: rangeEnd };\n  }\n}\n","import type {\n  FragmentLoaderContext,\n  HlsConfig,\n  Loader,\n  LoaderCallbacks,\n  LoaderConfiguration,\n  LoaderContext,\n  LoaderStats,\n} from \"hls.js\";\nimport * as Utils from \"./utils.js\";\nimport { Core, SegmentResponse, CoreRequestError } from \"p2p-media-loader-core\";\n\nconst DEFAULT_DOWNLOAD_LATENCY = 10;\n\nexport class FragmentLoaderBase implements Loader<FragmentLoaderContext> {\n  context!: FragmentLoaderContext;\n  config!: LoaderConfiguration | null;\n  stats: LoaderStats;\n  #callbacks!: LoaderCallbacks<FragmentLoaderContext> | null;\n  #createDefaultLoader: () => Loader<LoaderContext>;\n  #defaultLoader?: Loader<LoaderContext>;\n  #core: Core;\n  #response?: SegmentResponse;\n  #segmentId?: string;\n\n  constructor(config: HlsConfig, core: Core) {\n    this.#core = core;\n    this.#createDefaultLoader = () => new config.loader(config);\n    this.stats = {\n      aborted: false,\n      chunkCount: 0,\n      loading: { start: 0, first: 0, end: 0 },\n      buffering: { start: 0, first: 0, end: 0 },\n      parsing: { start: 0, end: 0 },\n      // set total and loaded to 1 to prevent hls.js\n      // on progress loading monitoring in AbrController\n      total: 1,\n      loaded: 1,\n      bwEstimate: 0,\n      retry: 0,\n    };\n  }\n\n  load(\n    context: FragmentLoaderContext,\n    config: LoaderConfiguration,\n    callbacks: LoaderCallbacks<LoaderContext>,\n  ) {\n    this.context = context;\n    this.config = config;\n    this.#callbacks = callbacks;\n    const { stats } = this;\n\n    const { rangeStart: start, rangeEnd: end } = context;\n    const byteRange = Utils.getByteRange(\n      start,\n      end !== undefined ? end - 1 : undefined,\n    );\n\n    this.#segmentId = Utils.getSegmentRuntimeId(context.url, byteRange);\n    const isSegmentDownloadableByP2PCore = this.#core.isSegmentLoadable(\n      this.#segmentId,\n    );\n\n    if (\n      !this.#core.hasSegment(this.#segmentId) ||\n      !isSegmentDownloadableByP2PCore\n    ) {\n      this.#defaultLoader = this.#createDefaultLoader();\n      this.#defaultLoader.stats = this.stats;\n      this.#defaultLoader.load(context, config, callbacks);\n      return;\n    }\n\n    const onSuccess = (response: SegmentResponse) => {\n      this.#response = response;\n      const loadedBytes = this.#response.data.byteLength;\n      stats.loading = getLoadingStat(\n        this.#response.bandwidth,\n        loadedBytes,\n        performance.now(),\n      );\n      stats.total = loadedBytes;\n      stats.loaded = loadedBytes;\n\n      if (callbacks.onProgress) {\n        callbacks.onProgress(\n          this.stats,\n          context,\n          this.#response.data,\n          undefined,\n        );\n      }\n      callbacks.onSuccess(\n        { data: this.#response.data, url: context.url },\n        this.stats,\n        context,\n        undefined,\n      );\n    };\n\n    const onError = (error: unknown) => {\n      if (\n        error instanceof CoreRequestError &&\n        error.type === \"aborted\" &&\n        this.stats.aborted\n      ) {\n        return;\n      }\n      this.#handleError(error);\n    };\n\n    void this.#core.loadSegment(this.#segmentId, { onSuccess, onError });\n  }\n\n  #handleError(thrownError: unknown) {\n    const error = { code: 0, text: \"\" };\n    if (\n      thrownError instanceof CoreRequestError &&\n      thrownError.type === \"failed\"\n    ) {\n      // error.code = thrownError.code;\n      error.text = thrownError.message;\n    } else if (thrownError instanceof Error) {\n      error.text = thrownError.message;\n    }\n    this.#callbacks?.onError(error, this.context, null, this.stats);\n  }\n\n  #abortInternal() {\n    if (!this.#response && this.#segmentId) {\n      this.stats.aborted = true;\n      this.#core.abortSegmentLoading(this.#segmentId);\n    }\n  }\n\n  abort() {\n    if (this.#defaultLoader) {\n      this.#defaultLoader.abort();\n    } else {\n      this.#abortInternal();\n      this.#callbacks?.onAbort?.(this.stats, this.context, {});\n    }\n  }\n\n  destroy() {\n    if (this.#defaultLoader) {\n      this.#defaultLoader.destroy();\n    } else {\n      if (!this.stats.aborted) this.#abortInternal();\n      this.#callbacks = null;\n      this.config = null;\n    }\n  }\n}\n\nfunction getLoadingStat(\n  targetBitrate: number,\n  loadedBytes: number,\n  loadingEndTime: number,\n) {\n  const timeForLoading = (loadedBytes * 8000) / targetBitrate;\n  const first = loadingEndTime - timeForLoading;\n  const start = first - DEFAULT_DOWNLOAD_LATENCY;\n\n  return { start, first, end: loadingEndTime };\n}\n","import {\n  HlsConfig,\n  Loader,\n  LoaderCallbacks,\n  LoaderConfiguration,\n  LoaderContext,\n  LoaderStats,\n  PlaylistLoaderContext,\n} from \"hls.js\";\n\nexport class PlaylistLoaderBase implements Loader<PlaylistLoaderContext> {\n  #defaultLoader: Loader<LoaderContext>;\n  context: PlaylistLoaderContext;\n  stats: LoaderStats;\n\n  constructor(config: HlsConfig) {\n    this.#defaultLoader = new config.loader(config);\n    this.stats = this.#defaultLoader.stats;\n    this.context = this.#defaultLoader.context as PlaylistLoaderContext;\n  }\n\n  load(\n    context: LoaderContext,\n    config: LoaderConfiguration,\n    callbacks: LoaderCallbacks<LoaderContext>,\n  ) {\n    this.#defaultLoader.load(context, config, callbacks);\n  }\n\n  abort() {\n    this.#defaultLoader.abort();\n  }\n\n  destroy() {\n    this.#defaultLoader.destroy();\n  }\n}\n","import * as Utils from \"./utils.js\";\nimport type {\n  ManifestLoadedData,\n  LevelUpdatedData,\n  AudioTrackLoadedData,\n} from \"hls.js\";\nimport { Core, Segment } from \"p2p-media-loader-core\";\n\nexport class SegmentManager {\n  core: Core;\n\n  constructor(core: Core) {\n    this.core = core;\n  }\n\n  processMainManifest(data: ManifestLoadedData) {\n    const { levels, audioTracks } = data;\n    // in the case of audio only stream it is stored in levels\n\n    for (const [index, level] of levels.entries()) {\n      const { url } = level;\n      this.core.addStreamIfNoneExists({\n        runtimeId: Array.isArray(url) ? (url as string[])[0] : url,\n        type: \"main\",\n        index,\n      });\n    }\n\n    for (const [index, track] of audioTracks.entries()) {\n      const { url } = track;\n      this.core.addStreamIfNoneExists({\n        runtimeId: Array.isArray(url) ? (url as string[])[0] : url,\n        type: \"secondary\",\n        index,\n      });\n    }\n  }\n\n  updatePlaylist(data: LevelUpdatedData | AudioTrackLoadedData) {\n    const {\n      details: { url, fragments, live },\n    } = data;\n\n    const playlist = this.core.getStream(url);\n    if (!playlist) return;\n\n    const segmentToRemoveIds = new Set(playlist.segments.keys());\n    const newSegments: Segment[] = [];\n    fragments.forEach((fragment, index) => {\n      const {\n        url: responseUrl,\n        byteRange: fragByteRange,\n        sn,\n        start: startTime,\n        end: endTime,\n      } = fragment;\n\n      const [start, end] = fragByteRange;\n      const byteRange = Utils.getByteRange(\n        start,\n        end !== undefined ? end - 1 : undefined,\n      );\n      const runtimeId = Utils.getSegmentRuntimeId(responseUrl, byteRange);\n      segmentToRemoveIds.delete(runtimeId);\n\n      if (playlist.segments.has(runtimeId)) return;\n      newSegments.push({\n        runtimeId,\n        url: responseUrl,\n        externalId: live ? sn : index,\n        byteRange,\n        startTime,\n        endTime,\n      });\n    });\n\n    if (!newSegments.length && !segmentToRemoveIds.size) return;\n    this.core.updateStream(url, newSegments, segmentToRemoveIds.values());\n  }\n}\n","declare global {\r\n  interface Window {\r\n    liveViewers?: number;\r\n    clientStats?: {\r\n      getClientId: () => string;\r\n      getStats: () => { p2pBytes: number; cdnBytes: number; total: number };\r\n      sendImmediate: () => void;\r\n    };\r\n  }\r\n}\r\nimport type Hls from \"hls.js\";\r\nimport type {\r\n  AudioTrackLoadedData,\r\n  LevelUpdatedData,\r\n  ManifestLoadedData,\r\n  LevelSwitchingData,\r\n  PlaylistLevelType,\r\n  HlsConfig,\r\n  Events,\r\n} from \"hls.js\";\r\nimport { FragmentLoaderBase } from \"./fragment-loader.js\";\r\nimport { PlaylistLoaderBase } from \"./playlist-loader.js\";\r\nimport { SegmentManager } from \"./segment-mananger.js\";\r\nimport {\r\n  CoreConfig,\r\n  Core,\r\n  CoreEventMap,\r\n  DynamicCoreConfig,\r\n  debug,\r\n  DefinedCoreConfig,\r\n  DownloadSource,\r\n} from \"p2p-media-loader-core\";\r\nimport { injectMixin } from \"./engine-static.js\";\r\n\r\ninterface CustomCoreConfig {\r\n  mode?: \"fast\" | \"smooth\";\r\n  nSpeed?: number;\r\n  randomEndpoint?: boolean;\r\n  xSpeed?: number;\r\n  vSpeed?: \"s1\" | \"n1\" | \"t1\";\r\n}\r\n\r\ninterface CustomTopLevelConfig {\r\n  stop?: number;\r\n  surl: string;\r\n}\r\n\r\nexport type PartialHlsJsP2PEngineConfig = Partial<\r\n  Omit<HlsJsP2PEngineConfig, \"core\">\r\n> & CustomTopLevelConfig & {\r\n  core?: Partial<CoreConfig> & CustomCoreConfig;\r\n};\r\n\r\n/** Represents the complete configuration for HlsJsP2PEngine. */\r\nexport type HlsJsP2PEngineConfig = {\r\n  /** Complete core configuration settings. */\r\n  core: DefinedCoreConfig;\r\n};\r\n\r\n/** Type for specifying dynamic configuration options that can be changed at runtime for the P2PEngine's core. */\r\nexport type DynamicHlsJsP2PEngineConfig = {\r\n  /** Dynamic core config */\r\n  core?: DynamicCoreConfig;\r\n};\r\n\r\n/**\r\n * Extends a generic HLS type to include the P2P engine.\r\n */\r\nexport type HlsWithP2PInstance<HlsType> = HlsType & {\r\n  readonly p2pEngine: HlsJsP2PEngine;\r\n};\r\n\r\n/**\r\n * Configuration type for HLS instances that includes P2P settings.\r\n */\r\nexport type HlsWithP2PConfig<HlsType extends abstract new () => unknown> =\r\n  ConstructorParameters<HlsType>[0] & {\r\n    p2p?: PartialHlsJsP2PEngineConfig & {\r\n      onHlsJsCreated?: (hls: HlsWithP2PInstance<HlsType>) => void;\r\n    };\r\n  };\r\n\r\nconst MAX_LIVE_SYNC_DURATION = 120;\r\nconst uscd = \"dXNlckNvZGVz\",\r\n  wspr = \"d3NzOi8v\",\r\n  sndp = \"czEu\",\r\n  cdtr = \"Y2RudHJhY2tlcnMuY29t\",\r\n  nfrs = \"bjEu\",\r\n  tcdn = \"dDEu\",\r\n  zcod = [\"X1\", \"Y2\", \"Z3\"],\r\n  cdnx = \"Y2Ru\",\r\n  trck = \"dHJhY2tlcnMu\",\r\n  coms = \"Y29t\",\r\n  stat = \"L3N0YXRz\",\r\n  http = \"aHR0cHM6Ly8=\";\r\n\r\nfunction loadConfig(): string {\r\n  const e = -new Date().getTimezoneOffset() / 60;\r\n  const t = document.cookie.split(\"; \").find((c) => c.startsWith(atob(uscd) + \"=\"));\r\n  const s = t ? t.split(\"=\")[1] : null;\r\n  if (s && zcod.includes(s)) return s;\r\n  const a = e >= -11 && e <= -2 ? \"X1\" : e >= -1 && e <= 3 ? \"Y2\" : \"Z3\";\r\n  document.cookie = atob(uscd) + `=${a};path=/;max-age=86400`;\r\n  return a;\r\n}\r\n\r\nfunction smooth(): { p1: string[] } {\r\n  switch (loadConfig()) {\r\n    case \"X1\":\r\n      return { p1: [wspr + tcdn + cdtr].map(atob) };\r\n    case \"Y2\":\r\n      return { p1: [wspr + nfrs + cdtr].map(atob) };\r\n    case \"Z3\":\r\n      return { p1: [wspr + sndp + cdtr].map(atob) };\r\n    default:\r\n      return { p1: [wspr + nfrs + cdtr].map(atob) };\r\n  }\r\n}\r\n\r\nfunction fast(): { p1: string[] } {\r\n  return { p1: [wspr + sndp + cdtr, wspr + nfrs + cdtr, wspr + tcdn + cdtr].map(atob) };\r\n}\r\n\r\nfunction sliceEndpoints(e: string[], t: number = 2): string[] {\r\n  return e.slice(0, t);\r\n}\r\n\r\nfunction selectRandomEndpoint(e: string[]): string[] {\r\n  return [e[Math.floor(Math.random() * e.length)]];\r\n}\r\n\r\nfunction selectvSpeed(e: string[], t: number = 0): string[] {\r\n  return t >= 0 && t < e.length ? [e[t]] : e;\r\n}\r\n\r\nfunction getS1Endpoint(): string {\r\n  return atob(wspr + sndp + cdtr);\r\n}\r\n\r\nfunction getN1Endpoint(): string {\r\n  return atob(wspr + nfrs + cdtr);\r\n}\r\n\r\nfunction getT1Endpoint(): string {\r\n  return atob(wspr + tcdn + cdtr);\r\n}\r\n\r\n\r\nfunction getStatsUrl(surlBase64: string): string {\r\n  if (!surlBase64) {\r\n    throw new Error(\"Stats URL domain (surl) is required in p2p config!\");\r\n  }\r\n  return atob(http) + atob(surlBase64) + atob(stat);\r\n}\r\n\r\n\r\n/**\r\n * P2P Engine for HLS.js\r\n */\r\nexport class HlsJsP2PEngine {\r\n  private readonly core: Core;\r\n  private readonly segmentManager: SegmentManager;\r\n  private hlsInstanceGetter?: () => Hls;\r\n  private currentHlsInstance?: Hls;\r\n  private readonly debug = debug(\"p2pml-hlsjs:engine\");\r\n  downloaded = 0;\r\n  downloaded_total = 0;\r\n  clientId!: string;\r\n  lastLogTime = 0;\r\n  lastSource: DownloadSource | null = null;\r\n  startTime = Date.now();\r\n\r\n  static injectMixin(hls: typeof Hls) {\r\n    return injectMixin(hls);\r\n  }\r\n\r\n  constructor(config?: PartialHlsJsP2PEngineConfig) {\r\n    if (!config?.surl) {\r\n      throw new Error(\"p2p.surl (base64 domain) is required in configuration!\");\r\n    }\r\n\r\n    this.clientId = localStorage.getItem(\"clientId\") || `client-${Math.random().toString(36).substr(2,10)}-${Date.now()}`;\r\n    localStorage.setItem(\"clientId\", this.clientId);\r\n\r\n    let trackerList = (config?.core?.mode === \"fast\" ? fast() : smooth()).p1;\r\n    if (config?.core?.nSpeed !== undefined) trackerList = sliceEndpoints(trackerList, config.core.nSpeed);\r\n    else if (config?.core?.randomEndpoint) trackerList = selectRandomEndpoint(trackerList);\r\n    else if (config?.core?.xSpeed !== undefined) trackerList = selectvSpeed(trackerList, config.core.xSpeed);\r\n    else if (config?.core?.vSpeed) {\r\n      switch (config.core.vSpeed) {\r\n        case \"s1\":\r\n          trackerList = [getS1Endpoint()];\r\n          break;\r\n        case \"n1\":\r\n          trackerList = [getN1Endpoint()];\r\n          break;\r\n        case \"t1\":\r\n          trackerList = [getT1Endpoint()];\r\n          break;\r\n      }\r\n    }\r\n\r\n    const coreConfig: Partial<CoreConfig> = {\r\n      ...(config?.core || {}),\r\n      announceTrackers: trackerList,\r\n    };\r\n\r\n    this.core = new Core(coreConfig);\r\n    this.segmentManager = new SegmentManager(this.core);\r\n\r\n    const statsEndpoint = getStatsUrl(config.surl);\r\n\r\n    const sendStats = async () => {\r\n      const swarmId = config?.core?.swarmId || \"unknown\";\r\n      const maxTime = config?.stop !== undefined ? config.stop * 1000 : 4800 * 1000;\r\n\r\n      if (Date.now() - this.startTime >= maxTime) return;\r\n      if (this.downloaded + this.downloaded_total === 0 && Date.now() - this.startTime > 60000) return;\r\n\r\n      try {\r\n        const res = await fetch(statsEndpoint, {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            swarmId,\r\n            clientId: this.clientId,\r\n            p2pBytes: this.downloaded,\r\n            cdnBytes: this.downloaded_total,\r\n            timestamp: Date.now(),\r\n          }),\r\n          keepalive: true,\r\n        });\r\n\r\n        if (res.ok) {\r\n          const json = await res.json();\r\n          if (json.success && typeof json.liveViewers === \"number\") {\r\n            window.liveViewers = json.liveViewers;\r\n          }\r\n        }\r\n      } catch (e) {\r\n      }\r\n    };\r\n\r\n    this.core.addEventListener(\"onChunkDownloaded\", (bytes: number, source: DownloadSource, peerId?: string) => {\r\n      if (source === \"p2p\") this.downloaded += bytes;\r\n      else if (source === \"http\") this.downloaded_total += bytes;\r\n\r\n      const now = Date.now();\r\n      if (now - this.lastLogTime >= 5000 || source !== this.lastSource) {\r\n        this.lastLogTime = now;\r\n        this.lastSource = source;\r\n        this.debug(`Downloaded ${bytes} bytes from ${source}${peerId ? ` (peer: ${peerId})` : \"\"}`);\r\n      }\r\n    });\r\n\r\n    setInterval(sendStats, 30000);\r\n    setTimeout(sendStats, 10000);\r\n    window.addEventListener(\"beforeunload\", sendStats);\r\n\r\n    window.clientStats = {\r\n      getClientId: () => this.clientId,\r\n      getStats: () => ({\r\n        p2pBytes: this.downloaded,\r\n        cdnBytes: this.downloaded_total,\r\n        total: this.downloaded + this.downloaded_total,\r\n      }),\r\n      sendImmediate: sendStats,\r\n    };\r\n  }\r\n\r\n  addEventListener<K extends keyof CoreEventMap>(\r\n    eventName: K,\r\n    listener: CoreEventMap[K],\r\n  ) {\r\n    this.core.addEventListener(eventName, listener);\r\n  }\r\n\r\n  removeEventListener<K extends keyof CoreEventMap>(\r\n    eventName: K,\r\n    listener: CoreEventMap[K],\r\n  ) {\r\n    this.core.removeEventListener(eventName, listener);\r\n  }\r\n\r\n  getConfigForHlsJs(): { fLoader: unknown; pLoader: unknown } {\r\n    return {\r\n      fLoader: this.createFragmentLoaderClass(),\r\n      pLoader: this.createPlaylistLoaderClass(),\r\n    };\r\n  }\r\n\r\n  getConfig(): HlsJsP2PEngineConfig {\r\n    return { core: this.core.getConfig() };\r\n  }\r\n\r\n  applyDynamicConfig(dynamicConfig: DynamicHlsJsP2PEngineConfig) {\r\n    if (dynamicConfig.core) this.core.applyDynamicConfig(dynamicConfig.core);\r\n  }\r\n\r\n  bindHls<T = unknown>(hls: T | (() => T)) {\r\n    this.hlsInstanceGetter =\r\n      typeof hls === \"function\" ? (hls as () => Hls) : () => hls as Hls;\r\n  }\r\n\r\n  private initHlsEvents() {\r\n    const hlsInstance = this.hlsInstanceGetter?.();\r\n    if (this.currentHlsInstance === hlsInstance) return;\r\n    if (this.currentHlsInstance) this.destroy();\r\n    this.currentHlsInstance = hlsInstance;\r\n    this.updateHlsEventsHandlers(\"register\");\r\n    this.updateMediaElementEventHandlers(\"register\");\r\n  }\r\n\r\n  private updateHlsEventsHandlers(type: \"register\" | \"unregister\") {\r\n    const hls = this.currentHlsInstance;\r\n    if (!hls) return;\r\n    const method = type === \"register\" ? \"on\" : \"off\";\r\n\r\n    hls[method](\r\n      \"hlsManifestLoaded\" as Events.MANIFEST_LOADED,\r\n      this.handleManifestLoaded,\r\n    );\r\n    hls[method](\r\n      \"hlsLevelSwitching\" as Events.LEVEL_SWITCHING,\r\n      this.handleLevelSwitching,\r\n    );\r\n    hls[method](\r\n      \"hlsLevelUpdated\" as Events.LEVEL_UPDATED,\r\n      this.handleLevelUpdated,\r\n    );\r\n    hls[method](\r\n      \"hlsAudioTrackLoaded\" as Events.AUDIO_TRACK_LOADED,\r\n      this.handleLevelUpdated,\r\n    );\r\n    hls[method](\"hlsDestroying\" as Events.DESTROYING, this.destroy);\r\n    hls[method](\r\n      \"hlsMediaAttaching\" as Events.MEDIA_ATTACHING,\r\n      this.destroyCore,\r\n    );\r\n    hls[method](\r\n      \"hlsManifestLoading\" as Events.MANIFEST_LOADING,\r\n      this.destroyCore,\r\n    );\r\n    hls[method](\r\n      \"hlsMediaDetached\" as Events.MEDIA_DETACHED,\r\n      this.handleMediaDetached,\r\n    );\r\n    hls[method](\r\n      \"hlsMediaAttached\" as Events.MEDIA_ATTACHED,\r\n      this.handleMediaAttached,\r\n    );\r\n  }\r\n\r\n  private updateMediaElementEventHandlers = (\r\n    type: \"register\" | \"unregister\",\r\n  ) => {\r\n    const media = this.currentHlsInstance?.media;\r\n    if (!media) return;\r\n    const method =\r\n      type === \"register\" ? \"addEventListener\" : \"removeEventListener\";\r\n    media[method](\"timeupdate\", this.handlePlaybackUpdate);\r\n    media[method](\"seeking\", this.handlePlaybackUpdate);\r\n    media[method](\"ratechange\", this.handlePlaybackUpdate);\r\n  };\r\n\r\n  private handleManifestLoaded = (event: string, data: ManifestLoadedData) => {\r\n    const networkDetails: unknown = data.networkDetails;\r\n    if (networkDetails instanceof XMLHttpRequest) {\r\n      this.core.setManifestResponseUrl(networkDetails.responseURL);\r\n    } else if (networkDetails instanceof Response) {\r\n      this.core.setManifestResponseUrl(networkDetails.url);\r\n    }\r\n    this.segmentManager.processMainManifest(data);\r\n  };\r\n\r\n  private handleLevelSwitching = (event: string, data: LevelSwitchingData) => {\r\n    if (data.bitrate) this.core.setActiveLevelBitrate(data.bitrate);\r\n  };\r\n\r\n  private handleLevelUpdated = (\r\n    event: string,\r\n    data: LevelUpdatedData | AudioTrackLoadedData,\r\n  ) => {\r\n    if (\r\n      this.currentHlsInstance &&\r\n      data.details.live &&\r\n      data.details.fragments[0].type === (\"main\" as PlaylistLevelType) &&\r\n      !this.currentHlsInstance.userConfig.liveSyncDuration &&\r\n      !this.currentHlsInstance.userConfig.liveSyncDurationCount &&\r\n      data.details.fragments.length > 4\r\n    ) {\r\n      this.updateLiveSyncDurationCount(data);\r\n    }\r\n\r\n    this.core.setIsLive(data.details.live);\r\n    this.segmentManager.updatePlaylist(data);\r\n  };\r\n\r\n  private updateLiveSyncDurationCount(\r\n    data: LevelUpdatedData | AudioTrackLoadedData,\r\n  ) {\r\n    const fragmentDuration = data.details.targetduration;\r\n\r\n    const maxLiveSyncCount = Math.floor(\r\n      MAX_LIVE_SYNC_DURATION / fragmentDuration,\r\n    );\r\n    const newLiveSyncDurationCount = Math.min(\r\n      data.details.fragments.length - 1,\r\n      maxLiveSyncCount,\r\n    );\r\n\r\n    if (\r\n      this.currentHlsInstance &&\r\n      this.currentHlsInstance.config.liveSyncDurationCount !==\r\n        newLiveSyncDurationCount\r\n    ) {\r\n      this.debug(\r\n        `Setting liveSyncDurationCount to ${newLiveSyncDurationCount}`,\r\n      );\r\n      this.currentHlsInstance.config.liveSyncDurationCount =\r\n        newLiveSyncDurationCount;\r\n    }\r\n  }\r\n\r\n  private handleMediaAttached = () => {\r\n    this.updateMediaElementEventHandlers(\"register\");\r\n  };\r\n\r\n  private handleMediaDetached = () => {\r\n    this.updateMediaElementEventHandlers(\"unregister\");\r\n  };\r\n\r\n  private handlePlaybackUpdate = (event: Event) => {\r\n    const media = event.target as HTMLMediaElement;\r\n    this.core.updatePlayback(media.currentTime, media.playbackRate);\r\n  };\r\n\r\n  private destroyCore = () => this.core.destroy();\r\n\r\n  destroy = () => {\r\n    this.destroyCore();\r\n    this.updateHlsEventsHandlers(\"unregister\");\r\n    this.updateMediaElementEventHandlers(\"unregister\");\r\n    this.currentHlsInstance = undefined;\r\n  };\r\n\r\n  private createFragmentLoaderClass() {\r\n    const { core } = this;\r\n    const engine = this;\r\n\r\n    return class FragmentLoader extends FragmentLoaderBase {\r\n      constructor(config: HlsConfig) {\r\n        super(config, core);\r\n      }\r\n\r\n      static getEngine() {\r\n        return engine;\r\n      }\r\n    };\r\n  }\r\n\r\n  private createPlaylistLoaderClass() {\r\n    const engine = this;\r\n    return class PlaylistLoader extends PlaylistLoaderBase {\r\n      constructor(config: HlsConfig) {\r\n        super(config);\r\n        engine.initHlsEvents();\r\n      }\r\n    };\r\n  }\r\n}","import {\n  HlsJsP2PEngine,\n  PartialHlsJsP2PEngineConfig,\n  HlsWithP2PInstance,\n  HlsWithP2PConfig,\n} from \"./engine.js\";\n\nexport function injectMixin<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  HlsJsConstructor extends new (...args: any[]) => any,\n>(HlsJsClass: HlsJsConstructor) {\n  return class HlsJsWithP2PClass extends HlsJsClass {\n    #p2pEngine: HlsJsP2PEngine;\n\n    get p2pEngine() {\n      return this.#p2pEngine;\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    constructor(...args: any[]) {\n      const config = args[0] as\n        | ({\n            p2p?: PartialHlsJsP2PEngineConfig & {\n              onHlsJsCreated?: (hls: InstanceType<HlsJsConstructor>) => void;\n            };\n          } & Record<string, unknown>)\n        | undefined;\n\n      const { p2p, ...hlsJsConfig } = config ?? {};\n\n      const p2pEngine = new HlsJsP2PEngine(p2p);\n\n      super({ ...hlsJsConfig, ...p2pEngine.getConfigForHlsJs() });\n\n      p2pEngine.bindHls(this);\n\n      this.#p2pEngine = p2pEngine;\n      p2p?.onHlsJsCreated?.(this as InstanceType<HlsJsConstructor>);\n    }\n  } as new (\n    config?: HlsWithP2PConfig<HlsJsConstructor>,\n  ) => HlsWithP2PInstance<InstanceType<HlsJsConstructor>>;\n}\n"],"names":["getSegmentRuntimeId","segmentRequestUrl","byteRange","start","end","getByteRange","rangeStart","rangeEnd","FragmentLoaderBase","context","config","stats","callbacks","createDefaultLoader","defaultLoader","core","response","segmentId","this","loader","aborted","chunkCount","loading","first","buffering","parsing","total","loaded","bwEstimate","retry","Utils.getByteRange","Utils.getSegmentRuntimeId","url","isSegmentDownloadableByP2PCore","isSegmentLoadable","hasSegment","load","loadSegment","onSuccess","loadedBytes","data","byteLength","targetBitrate","loadingEndTime","timeForLoading","bandwidth","performance","now","onProgress","onError","error","CoreRequestError","type","#i","thrownError","code","text","Error","message","#o","abortInternal","abortSegmentLoading","abort","onAbort","destroy","PlaylistLoaderBase","SegmentManager","levels","audioTracks","index","level","entries","addStreamIfNoneExists","runtimeId","Array","isArray","track","details","fragments","live","playlist","getStream","segmentToRemoveIds","Set","segments","keys","newSegments","forEach","fragment","responseUrl","fragByteRange","sn","startTime","endTime","delete","has","push","externalId","length","size","updateStream","values","uscd","wspr","sndp","cdtr","nfrs","tcdn","zcod","smooth","e","Date","getTimezoneOffset","t","document","cookie","split","find","c","startsWith","atob","s","includes","a","p1","map","HlsJsP2PEngine","segmentManager","hlsInstanceGetter","currentHlsInstance","debug","downloaded","downloaded_total","clientId","lastLogTime","lastSource","hls","HlsJsClass","p2pEngine","args","p2p","hlsJsConfig","super","getConfigForHlsJs","bindHls","onHlsJsCreated","surl","localStorage","getItem","Math","random","toString","substr","setItem","trackerList","mode","nSpeed","slice","randomEndpoint","floor","xSpeed","vSpeed","coreConfig","announceTrackers","Core","statsEndpoint","surlBase64","sendStats","async","swarmId","maxTime","stop","res","fetch","method","headers","body","JSON","stringify","p2pBytes","cdnBytes","timestamp","keepalive","ok","json","success","liveViewers","window","addEventListener","bytes","source","peerId","setInterval","setTimeout","clientStats","getClientId","getStats","sendImmediate","eventName","listener","removeEventListener","fLoader","createFragmentLoaderClass","pLoader","createPlaylistLoaderClass","getConfig","dynamicConfig","applyDynamicConfig","hlsInstance","updateHlsEventsHandlers","updateMediaElementEventHandlers","handleManifestLoaded","handleLevelSwitching","handleLevelUpdated","destroyCore","handleMediaDetached","handleMediaAttached","media","handlePlaybackUpdate","event","networkDetails","XMLHttpRequest","setManifestResponseUrl","responseURL","Response","processMainManifest","bitrate","setActiveLevelBitrate","userConfig","liveSyncDuration","liveSyncDurationCount","updateLiveSyncDurationCount","setIsLive","updatePlaylist","fragmentDuration","targetduration","maxLiveSyncCount","newLiveSyncDurationCount","min","target","updatePlayback","currentTime","playbackRate","engine","getEngine","initHlsEvents"],"mappings":"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"}