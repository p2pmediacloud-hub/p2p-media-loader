{"version":3,"file":"p2p-media-loader-hlsjs.js","sources":["../src/utils.ts","../src/fragment-loader.ts","../src/playlist-loader.ts","../src/segment-mananger.ts","../src/engine-static.ts","../src/engine.ts"],"sourcesContent":["import { ByteRange } from \"p2p-media-loader-core\";\n\nexport function getSegmentRuntimeId(\n  segmentRequestUrl: string,\n  byteRange?: ByteRange,\n) {\n  if (!byteRange) return segmentRequestUrl;\n  return `${segmentRequestUrl}|${byteRange.start}-${byteRange.end}`;\n}\n\nexport function getByteRange(\n  rangeStart: number | undefined,\n  rangeEnd: number | undefined,\n): ByteRange | undefined {\n  if (\n    rangeStart !== undefined &&\n    rangeEnd !== undefined &&\n    rangeStart <= rangeEnd\n  ) {\n    return { start: rangeStart, end: rangeEnd };\n  }\n}\n","import type {\n  FragmentLoaderContext,\n  HlsConfig,\n  Loader,\n  LoaderCallbacks,\n  LoaderConfiguration,\n  LoaderContext,\n  LoaderStats,\n} from \"hls.js\";\nimport * as Utils from \"./utils.js\";\nimport { Core, SegmentResponse, CoreRequestError } from \"p2p-media-loader-core\";\n\nconst DEFAULT_DOWNLOAD_LATENCY = 10;\n\nexport class FragmentLoaderBase implements Loader<FragmentLoaderContext> {\n  context!: FragmentLoaderContext;\n  config!: LoaderConfiguration | null;\n  stats: LoaderStats;\n  #callbacks!: LoaderCallbacks<FragmentLoaderContext> | null;\n  #createDefaultLoader: () => Loader<LoaderContext>;\n  #defaultLoader?: Loader<LoaderContext>;\n  #core: Core;\n  #response?: SegmentResponse;\n  #segmentId?: string;\n\n  constructor(config: HlsConfig, core: Core) {\n    this.#core = core;\n    this.#createDefaultLoader = () => new config.loader(config);\n    this.stats = {\n      aborted: false,\n      chunkCount: 0,\n      loading: { start: 0, first: 0, end: 0 },\n      buffering: { start: 0, first: 0, end: 0 },\n      parsing: { start: 0, end: 0 },\n      // set total and loaded to 1 to prevent hls.js\n      // on progress loading monitoring in AbrController\n      total: 1,\n      loaded: 1,\n      bwEstimate: 0,\n      retry: 0,\n    };\n  }\n\n  load(\n    context: FragmentLoaderContext,\n    config: LoaderConfiguration,\n    callbacks: LoaderCallbacks<LoaderContext>,\n  ) {\n    this.context = context;\n    this.config = config;\n    this.#callbacks = callbacks;\n    const { stats } = this;\n\n    const { rangeStart: start, rangeEnd: end } = context;\n    const byteRange = Utils.getByteRange(\n      start,\n      end !== undefined ? end - 1 : undefined,\n    );\n\n    this.#segmentId = Utils.getSegmentRuntimeId(context.url, byteRange);\n    const isSegmentDownloadableByP2PCore = this.#core.isSegmentLoadable(\n      this.#segmentId,\n    );\n\n    if (\n      !this.#core.hasSegment(this.#segmentId) ||\n      !isSegmentDownloadableByP2PCore\n    ) {\n      this.#defaultLoader = this.#createDefaultLoader();\n      this.#defaultLoader.stats = this.stats;\n      this.#defaultLoader.load(context, config, callbacks);\n      return;\n    }\n\n    const onSuccess = (response: SegmentResponse) => {\n      this.#response = response;\n      const loadedBytes = this.#response.data.byteLength;\n      stats.loading = getLoadingStat(\n        this.#response.bandwidth,\n        loadedBytes,\n        performance.now(),\n      );\n      stats.total = loadedBytes;\n      stats.loaded = loadedBytes;\n\n      if (callbacks.onProgress) {\n        callbacks.onProgress(\n          this.stats,\n          context,\n          this.#response.data,\n          undefined,\n        );\n      }\n      callbacks.onSuccess(\n        { data: this.#response.data, url: context.url },\n        this.stats,\n        context,\n        undefined,\n      );\n    };\n\n    const onError = (error: unknown) => {\n      if (\n        error instanceof CoreRequestError &&\n        error.type === \"aborted\" &&\n        this.stats.aborted\n      ) {\n        return;\n      }\n      this.#handleError(error);\n    };\n\n    void this.#core.loadSegment(this.#segmentId, { onSuccess, onError });\n  }\n\n  #handleError(thrownError: unknown) {\n    const error = { code: 0, text: \"\" };\n    if (\n      thrownError instanceof CoreRequestError &&\n      thrownError.type === \"failed\"\n    ) {\n      // error.code = thrownError.code;\n      error.text = thrownError.message;\n    } else if (thrownError instanceof Error) {\n      error.text = thrownError.message;\n    }\n    this.#callbacks?.onError(error, this.context, null, this.stats);\n  }\n\n  #abortInternal() {\n    if (!this.#response && this.#segmentId) {\n      this.stats.aborted = true;\n      this.#core.abortSegmentLoading(this.#segmentId);\n    }\n  }\n\n  abort() {\n    if (this.#defaultLoader) {\n      this.#defaultLoader.abort();\n    } else {\n      this.#abortInternal();\n      this.#callbacks?.onAbort?.(this.stats, this.context, {});\n    }\n  }\n\n  destroy() {\n    if (this.#defaultLoader) {\n      this.#defaultLoader.destroy();\n    } else {\n      if (!this.stats.aborted) this.#abortInternal();\n      this.#callbacks = null;\n      this.config = null;\n    }\n  }\n}\n\nfunction getLoadingStat(\n  targetBitrate: number,\n  loadedBytes: number,\n  loadingEndTime: number,\n) {\n  const timeForLoading = (loadedBytes * 8000) / targetBitrate;\n  const first = loadingEndTime - timeForLoading;\n  const start = first - DEFAULT_DOWNLOAD_LATENCY;\n\n  return { start, first, end: loadingEndTime };\n}\n","import {\n  HlsConfig,\n  Loader,\n  LoaderCallbacks,\n  LoaderConfiguration,\n  LoaderContext,\n  LoaderStats,\n  PlaylistLoaderContext,\n} from \"hls.js\";\n\nexport class PlaylistLoaderBase implements Loader<PlaylistLoaderContext> {\n  #defaultLoader: Loader<LoaderContext>;\n  context: PlaylistLoaderContext;\n  stats: LoaderStats;\n\n  constructor(config: HlsConfig) {\n    this.#defaultLoader = new config.loader(config);\n    this.stats = this.#defaultLoader.stats;\n    this.context = this.#defaultLoader.context as PlaylistLoaderContext;\n  }\n\n  load(\n    context: LoaderContext,\n    config: LoaderConfiguration,\n    callbacks: LoaderCallbacks<LoaderContext>,\n  ) {\n    this.#defaultLoader.load(context, config, callbacks);\n  }\n\n  abort() {\n    this.#defaultLoader.abort();\n  }\n\n  destroy() {\n    this.#defaultLoader.destroy();\n  }\n}\n","import * as Utils from \"./utils.js\";\nimport type {\n  ManifestLoadedData,\n  LevelUpdatedData,\n  AudioTrackLoadedData,\n} from \"hls.js\";\nimport { Core, Segment } from \"p2p-media-loader-core\";\n\nexport class SegmentManager {\n  core: Core;\n\n  constructor(core: Core) {\n    this.core = core;\n  }\n\n  processMainManifest(data: ManifestLoadedData) {\n    const { levels, audioTracks } = data;\n    // in the case of audio only stream it is stored in levels\n\n    for (const [index, level] of levels.entries()) {\n      const { url } = level;\n      this.core.addStreamIfNoneExists({\n        runtimeId: Array.isArray(url) ? (url as string[])[0] : url,\n        type: \"main\",\n        index,\n      });\n    }\n\n    for (const [index, track] of audioTracks.entries()) {\n      const { url } = track;\n      this.core.addStreamIfNoneExists({\n        runtimeId: Array.isArray(url) ? (url as string[])[0] : url,\n        type: \"secondary\",\n        index,\n      });\n    }\n  }\n\n  updatePlaylist(data: LevelUpdatedData | AudioTrackLoadedData) {\n    const {\n      details: { url, fragments, live },\n    } = data;\n\n    const playlist = this.core.getStream(url);\n    if (!playlist) return;\n\n    const segmentToRemoveIds = new Set(playlist.segments.keys());\n    const newSegments: Segment[] = [];\n    fragments.forEach((fragment, index) => {\n      const {\n        url: responseUrl,\n        byteRange: fragByteRange,\n        sn,\n        start: startTime,\n        end: endTime,\n      } = fragment;\n\n      const [start, end] = fragByteRange;\n      const byteRange = Utils.getByteRange(\n        start,\n        end !== undefined ? end - 1 : undefined,\n      );\n      const runtimeId = Utils.getSegmentRuntimeId(responseUrl, byteRange);\n      segmentToRemoveIds.delete(runtimeId);\n\n      if (playlist.segments.has(runtimeId)) return;\n      newSegments.push({\n        runtimeId,\n        url: responseUrl,\n        externalId: live ? sn : index,\n        byteRange,\n        startTime,\n        endTime,\n      });\n    });\n\n    if (!newSegments.length && !segmentToRemoveIds.size) return;\n    this.core.updateStream(url, newSegments, segmentToRemoveIds.values());\n  }\n}\n","import {\n  HlsJsP2PEngine,\n  PartialHlsJsP2PEngineConfig,\n  HlsWithP2PInstance,\n  HlsWithP2PConfig,\n} from \"./engine.js\";\n\nexport function injectMixin<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  HlsJsConstructor extends new (...args: any[]) => any,\n>(HlsJsClass: HlsJsConstructor) {\n  return class HlsJsWithP2PClass extends HlsJsClass {\n    #p2pEngine: HlsJsP2PEngine;\n\n    get p2pEngine() {\n      return this.#p2pEngine;\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    constructor(...args: any[]) {\n      const config = args[0] as\n        | ({\n            p2p?: PartialHlsJsP2PEngineConfig & {\n              onHlsJsCreated?: (hls: InstanceType<HlsJsConstructor>) => void;\n            };\n          } & Record<string, unknown>)\n        | undefined;\n\n      const { p2p, ...hlsJsConfig } = config ?? {};\n\n      const p2pEngine = new HlsJsP2PEngine(p2p);\n\n      super({ ...hlsJsConfig, ...p2pEngine.getConfigForHlsJs() });\n\n      p2pEngine.bindHls(this);\n\n      this.#p2pEngine = p2pEngine;\n      p2p?.onHlsJsCreated?.(this as InstanceType<HlsJsConstructor>);\n    }\n  } as new (\n    config?: HlsWithP2PConfig<HlsJsConstructor>,\n  ) => HlsWithP2PInstance<InstanceType<HlsJsConstructor>>;\n}\n","declare global {\r\n  interface Window {\r\n    liveViewers?: number;\r\n    clientStats?: {\r\n      getClientId: () => string;\r\n      getStats: () => { p2pBytes: number; cdnBytes: number; total: number };\r\n      sendImmediate: () => void;\r\n    };\r\n  }\r\n}\r\nimport type Hls from \"hls.js\";\r\nimport type {\r\n  AudioTrackLoadedData,\r\n  LevelUpdatedData,\r\n  ManifestLoadedData,\r\n  LevelSwitchingData,\r\n  PlaylistLevelType,\r\n  HlsConfig,\r\n  Events,\r\n} from \"hls.js\";\r\nimport { FragmentLoaderBase } from \"./fragment-loader.js\";\r\nimport { PlaylistLoaderBase } from \"./playlist-loader.js\";\r\nimport { SegmentManager } from \"./segment-mananger.js\";\r\nimport {\r\n  CoreConfig,\r\n  Core,\r\n  CoreEventMap,\r\n  DynamicCoreConfig,\r\n  debug,\r\n  DefinedCoreConfig,\r\n  DownloadSource,\r\n} from \"p2p-media-loader-core\";\r\nimport { injectMixin } from \"./engine-static.js\";\r\n\r\ninterface CustomCoreConfig {\r\n  mode?: \"fast\" | \"smooth\";\r\n  nSpeed?: number;\r\n  randomEndpoint?: boolean;\r\n  xSpeed?: number;\r\n  vSpeed?: \"s1\" | \"n1\" | \"t1\";\r\n}\r\n\r\ninterface CustomTopLevelConfig {\r\n  stop?: number;\r\n  surl: string;\r\n}\r\n\r\nexport type PartialHlsJsP2PEngineConfig = Partial<\r\n  Omit<HlsJsP2PEngineConfig, \"core\">\r\n> & CustomTopLevelConfig & {\r\n  core?: Partial<CoreConfig> & CustomCoreConfig;\r\n};\r\n\r\n/** Represents the complete configuration for HlsJsP2PEngine. */\r\nexport type HlsJsP2PEngineConfig = {\r\n  /** Complete core configuration settings. */\r\n  core: DefinedCoreConfig;\r\n};\r\n\r\n/** Type for specifying dynamic configuration options that can be changed at runtime for the P2PEngine's core. */\r\nexport type DynamicHlsJsP2PEngineConfig = {\r\n  /** Dynamic core config */\r\n  core?: DynamicCoreConfig;\r\n};\r\n\r\n/**\r\n * Extends a generic HLS type to include the P2P engine.\r\n */\r\nexport type HlsWithP2PInstance<HlsType> = HlsType & {\r\n  readonly p2pEngine: HlsJsP2PEngine;\r\n};\r\n\r\n/**\r\n * Configuration type for HLS instances that includes P2P settings.\r\n */\r\nexport type HlsWithP2PConfig<HlsType extends abstract new () => unknown> =\r\n  ConstructorParameters<HlsType>[0] & {\r\n    p2p?: PartialHlsJsP2PEngineConfig & {\r\n      onHlsJsCreated?: (hls: HlsWithP2PInstance<HlsType>) => void;\r\n    };\r\n  };\r\n\r\nconst MAX_LIVE_SYNC_DURATION = 120;\r\nconst uscd = \"dXNlckNvZGVz\",\r\n  wspr = \"d3NzOi8v\",\r\n  sndp = \"czEu\",\r\n  cdtr = \"Y2RudHJhY2tlcnMuY29t\",\r\n  nfrs = \"bjEu\",\r\n  tcdn = \"dDEu\",\r\n  zcod = [\"X1\", \"Y2\", \"Z3\"],\r\n  cdnx = \"Y2Ru\",\r\n  trck = \"dHJhY2tlcnMu\",\r\n  coms = \"Y29t\",\r\n  stat = \"L3N0YXRz\",\r\n  http = \"aHR0cHM6Ly8=\";\r\n\r\nfunction loadConfig(): string {\r\n  const e = -new Date().getTimezoneOffset() / 60;\r\n  const t = document.cookie.split(\"; \").find((c) => c.startsWith(atob(uscd) + \"=\"));\r\n  const s = t ? t.split(\"=\")[1] : null;\r\n  if (s && zcod.includes(s)) return s;\r\n  const a = e >= -11 && e <= -2 ? \"X1\" : e >= -1 && e <= 3 ? \"Y2\" : \"Z3\";\r\n  document.cookie = atob(uscd) + `=${a};path=/;max-age=86400`;\r\n  return a;\r\n}\r\n\r\nfunction smooth(): { p1: string[] } {\r\n  switch (loadConfig()) {\r\n    case \"X1\":\r\n      return { p1: [wspr + tcdn + cdtr].map(atob) };\r\n    case \"Y2\":\r\n      return { p1: [wspr + nfrs + cdtr].map(atob) };\r\n    case \"Z3\":\r\n      return { p1: [wspr + sndp + cdtr].map(atob) };\r\n    default:\r\n      return { p1: [wspr + nfrs + cdtr].map(atob) };\r\n  }\r\n}\r\n\r\nfunction fast(): { p1: string[] } {\r\n  return { p1: [wspr + sndp + cdtr, wspr + nfrs + cdtr, wspr + tcdn + cdtr].map(atob) };\r\n}\r\n\r\nfunction sliceEndpoints(e: string[], t: number = 2): string[] {\r\n  return e.slice(0, t);\r\n}\r\n\r\nfunction selectRandomEndpoint(e: string[]): string[] {\r\n  return [e[Math.floor(Math.random() * e.length)]];\r\n}\r\n\r\nfunction selectvSpeed(e: string[], t: number = 0): string[] {\r\n  return t >= 0 && t < e.length ? [e[t]] : e;\r\n}\r\n\r\nfunction getS1Endpoint(): string {\r\n  return atob(wspr + sndp + cdtr);\r\n}\r\n\r\nfunction getN1Endpoint(): string {\r\n  return atob(wspr + nfrs + cdtr);\r\n}\r\n\r\nfunction getT1Endpoint(): string {\r\n  return atob(wspr + tcdn + cdtr);\r\n}\r\n\r\n\r\nfunction getStatsUrl(surlBase64: string): string {\r\n  if (!surlBase64) {\r\n    throw new Error(\"Stats URL domain (surl) is required in p2p config!\");\r\n  }\r\n  return atob(http) + atob(surlBase64) + atob(stat);\r\n}\r\n\r\n\r\n/**\r\n * P2P Engine for HLS.js\r\n */\r\nexport class HlsJsP2PEngine {\r\n  private readonly core: Core;\r\n  private readonly segmentManager: SegmentManager;\r\n  private hlsInstanceGetter?: () => Hls;\r\n  private currentHlsInstance?: Hls;\r\n  private readonly debug = debug(\"p2pml-hlsjs:engine\");\r\n  downloaded = 0;\r\n  downloaded_total = 0;\r\n  clientId!: string;\r\n  lastLogTime = 0;\r\n  lastSource: DownloadSource | null = null;\r\n  startTime = Date.now();\r\n\r\n  static injectMixin(hls: typeof Hls) {\r\n    return injectMixin(hls);\r\n  }\r\n\r\n  constructor(config?: PartialHlsJsP2PEngineConfig) {\r\n    if (!config?.surl) {\r\n      throw new Error(\"p2p.surl (base64 domain) is required in configuration!\");\r\n    }\r\n\r\n    this.clientId = localStorage.getItem(\"clientId\") || `client-${Math.random().toString(36).substr(2,10)}-${Date.now()}`;\r\n    localStorage.setItem(\"clientId\", this.clientId);\r\n\r\n    let trackerList = (config?.core?.mode === \"fast\" ? fast() : smooth()).p1;\r\n    if (config?.core?.nSpeed !== undefined) trackerList = sliceEndpoints(trackerList, config.core.nSpeed);\r\n    else if (config?.core?.randomEndpoint) trackerList = selectRandomEndpoint(trackerList);\r\n    else if (config?.core?.xSpeed !== undefined) trackerList = selectvSpeed(trackerList, config.core.xSpeed);\r\n    else if (config?.core?.vSpeed) {\r\n      switch (config.core.vSpeed) {\r\n        case \"s1\":\r\n          trackerList = [getS1Endpoint()];\r\n          break;\r\n        case \"n1\":\r\n          trackerList = [getN1Endpoint()];\r\n          break;\r\n        case \"t1\":\r\n          trackerList = [getT1Endpoint()];\r\n          break;\r\n      }\r\n    }\r\n\r\n    const coreConfig: Partial<CoreConfig> = {\r\n      ...(config?.core || {}),\r\n      announceTrackers: trackerList,\r\n    };\r\n\r\n    this.core = new Core(coreConfig);\r\n    this.segmentManager = new SegmentManager(this.core);\r\n\r\n    const statsEndpoint = getStatsUrl(config.surl);\r\n\r\n    const sendStats = async () => {\r\n      const swarmId = config?.core?.swarmId || \"unknown\";\r\n      const maxTime = config?.stop !== undefined ? config.stop * 1000 : 4800 * 1000;\r\n\r\n      if (Date.now() - this.startTime >= maxTime) return;\r\n      if (this.downloaded + this.downloaded_total === 0 && Date.now() - this.startTime > 60000) return;\r\n\r\n      try {\r\n        const res = await fetch(statsEndpoint, {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            swarmId,\r\n            clientId: this.clientId,\r\n            p2pBytes: this.downloaded,\r\n            cdnBytes: this.downloaded_total,\r\n            timestamp: Date.now(),\r\n          }),\r\n          keepalive: true,\r\n        });\r\n\r\n        if (res.ok) {\r\n          const json = await res.json();\r\n          if (json.success && typeof json.liveViewers === \"number\") {\r\n            window.liveViewers = json.liveViewers;\r\n          }\r\n        }\r\n      } catch (e) {\r\n      }\r\n    };\r\n\r\n    this.core.addEventListener(\"onChunkDownloaded\", (bytes: number, source: DownloadSource, peerId?: string) => {\r\n      if (source === \"p2p\") this.downloaded += bytes;\r\n      else if (source === \"http\") this.downloaded_total += bytes;\r\n\r\n      const now = Date.now();\r\n      if (now - this.lastLogTime >= 5000 || source !== this.lastSource) {\r\n        this.lastLogTime = now;\r\n        this.lastSource = source;\r\n        this.debug(`Downloaded ${bytes} bytes from ${source}${peerId ? ` (peer: ${peerId})` : \"\"}`);\r\n      }\r\n    });\r\n\r\n    setInterval(sendStats, 30000);\r\n    setTimeout(sendStats, 10000);\r\n    window.addEventListener(\"beforeunload\", sendStats);\r\n\r\n    window.clientStats = {\r\n      getClientId: () => this.clientId,\r\n      getStats: () => ({\r\n        p2pBytes: this.downloaded,\r\n        cdnBytes: this.downloaded_total,\r\n        total: this.downloaded + this.downloaded_total,\r\n      }),\r\n      sendImmediate: sendStats,\r\n    };\r\n  }\r\n\r\n  addEventListener<K extends keyof CoreEventMap>(\r\n    eventName: K,\r\n    listener: CoreEventMap[K],\r\n  ) {\r\n    this.core.addEventListener(eventName, listener);\r\n  }\r\n\r\n  removeEventListener<K extends keyof CoreEventMap>(\r\n    eventName: K,\r\n    listener: CoreEventMap[K],\r\n  ) {\r\n    this.core.removeEventListener(eventName, listener);\r\n  }\r\n\r\n  getConfigForHlsJs(): { fLoader: unknown; pLoader: unknown } {\r\n    return {\r\n      fLoader: this.createFragmentLoaderClass(),\r\n      pLoader: this.createPlaylistLoaderClass(),\r\n    };\r\n  }\r\n\r\n  getConfig(): HlsJsP2PEngineConfig {\r\n    return { core: this.core.getConfig() };\r\n  }\r\n\r\n  applyDynamicConfig(dynamicConfig: DynamicHlsJsP2PEngineConfig) {\r\n    if (dynamicConfig.core) this.core.applyDynamicConfig(dynamicConfig.core);\r\n  }\r\n\r\n  bindHls<T = unknown>(hls: T | (() => T)) {\r\n    this.hlsInstanceGetter =\r\n      typeof hls === \"function\" ? (hls as () => Hls) : () => hls as Hls;\r\n  }\r\n\r\n  private initHlsEvents() {\r\n    const hlsInstance = this.hlsInstanceGetter?.();\r\n    if (this.currentHlsInstance === hlsInstance) return;\r\n    if (this.currentHlsInstance) this.destroy();\r\n    this.currentHlsInstance = hlsInstance;\r\n    this.updateHlsEventsHandlers(\"register\");\r\n    this.updateMediaElementEventHandlers(\"register\");\r\n  }\r\n\r\n  private updateHlsEventsHandlers(type: \"register\" | \"unregister\") {\r\n    const hls = this.currentHlsInstance;\r\n    if (!hls) return;\r\n    const method = type === \"register\" ? \"on\" : \"off\";\r\n\r\n    hls[method](\r\n      \"hlsManifestLoaded\" as Events.MANIFEST_LOADED,\r\n      this.handleManifestLoaded,\r\n    );\r\n    hls[method](\r\n      \"hlsLevelSwitching\" as Events.LEVEL_SWITCHING,\r\n      this.handleLevelSwitching,\r\n    );\r\n    hls[method](\r\n      \"hlsLevelUpdated\" as Events.LEVEL_UPDATED,\r\n      this.handleLevelUpdated,\r\n    );\r\n    hls[method](\r\n      \"hlsAudioTrackLoaded\" as Events.AUDIO_TRACK_LOADED,\r\n      this.handleLevelUpdated,\r\n    );\r\n    hls[method](\"hlsDestroying\" as Events.DESTROYING, this.destroy);\r\n    hls[method](\r\n      \"hlsMediaAttaching\" as Events.MEDIA_ATTACHING,\r\n      this.destroyCore,\r\n    );\r\n    hls[method](\r\n      \"hlsManifestLoading\" as Events.MANIFEST_LOADING,\r\n      this.destroyCore,\r\n    );\r\n    hls[method](\r\n      \"hlsMediaDetached\" as Events.MEDIA_DETACHED,\r\n      this.handleMediaDetached,\r\n    );\r\n    hls[method](\r\n      \"hlsMediaAttached\" as Events.MEDIA_ATTACHED,\r\n      this.handleMediaAttached,\r\n    );\r\n  }\r\n\r\n  private updateMediaElementEventHandlers = (\r\n    type: \"register\" | \"unregister\",\r\n  ) => {\r\n    const media = this.currentHlsInstance?.media;\r\n    if (!media) return;\r\n    const method =\r\n      type === \"register\" ? \"addEventListener\" : \"removeEventListener\";\r\n    media[method](\"timeupdate\", this.handlePlaybackUpdate);\r\n    media[method](\"seeking\", this.handlePlaybackUpdate);\r\n    media[method](\"ratechange\", this.handlePlaybackUpdate);\r\n  };\r\n\r\n  private handleManifestLoaded = (event: string, data: ManifestLoadedData) => {\r\n    const networkDetails: unknown = data.networkDetails;\r\n    if (networkDetails instanceof XMLHttpRequest) {\r\n      this.core.setManifestResponseUrl(networkDetails.responseURL);\r\n    } else if (networkDetails instanceof Response) {\r\n      this.core.setManifestResponseUrl(networkDetails.url);\r\n    }\r\n    this.segmentManager.processMainManifest(data);\r\n  };\r\n\r\n  private handleLevelSwitching = (event: string, data: LevelSwitchingData) => {\r\n    if (data.bitrate) this.core.setActiveLevelBitrate(data.bitrate);\r\n  };\r\n\r\n  private handleLevelUpdated = (\r\n    event: string,\r\n    data: LevelUpdatedData | AudioTrackLoadedData,\r\n  ) => {\r\n    if (\r\n      this.currentHlsInstance &&\r\n      data.details.live &&\r\n      data.details.fragments[0].type === (\"main\" as PlaylistLevelType) &&\r\n      !this.currentHlsInstance.userConfig.liveSyncDuration &&\r\n      !this.currentHlsInstance.userConfig.liveSyncDurationCount &&\r\n      data.details.fragments.length > 4\r\n    ) {\r\n      this.updateLiveSyncDurationCount(data);\r\n    }\r\n\r\n    this.core.setIsLive(data.details.live);\r\n    this.segmentManager.updatePlaylist(data);\r\n  };\r\n\r\n  private updateLiveSyncDurationCount(\r\n    data: LevelUpdatedData | AudioTrackLoadedData,\r\n  ) {\r\n    const fragmentDuration = data.details.targetduration;\r\n\r\n    const maxLiveSyncCount = Math.floor(\r\n      MAX_LIVE_SYNC_DURATION / fragmentDuration,\r\n    );\r\n    const newLiveSyncDurationCount = Math.min(\r\n      data.details.fragments.length - 1,\r\n      maxLiveSyncCount,\r\n    );\r\n\r\n    if (\r\n      this.currentHlsInstance &&\r\n      this.currentHlsInstance.config.liveSyncDurationCount !==\r\n        newLiveSyncDurationCount\r\n    ) {\r\n      this.debug(\r\n        `Setting liveSyncDurationCount to ${newLiveSyncDurationCount}`,\r\n      );\r\n      this.currentHlsInstance.config.liveSyncDurationCount =\r\n        newLiveSyncDurationCount;\r\n    }\r\n  }\r\n\r\n  private handleMediaAttached = () => {\r\n    this.updateMediaElementEventHandlers(\"register\");\r\n  };\r\n\r\n  private handleMediaDetached = () => {\r\n    this.updateMediaElementEventHandlers(\"unregister\");\r\n  };\r\n\r\n  private handlePlaybackUpdate = (event: Event) => {\r\n    const media = event.target as HTMLMediaElement;\r\n    this.core.updatePlayback(media.currentTime, media.playbackRate);\r\n  };\r\n\r\n  private destroyCore = () => this.core.destroy();\r\n\r\n  destroy = () => {\r\n    this.destroyCore();\r\n    this.updateHlsEventsHandlers(\"unregister\");\r\n    this.updateMediaElementEventHandlers(\"unregister\");\r\n    this.currentHlsInstance = undefined;\r\n  };\r\n\r\n  private createFragmentLoaderClass() {\r\n    const { core } = this;\r\n    const engine = this;\r\n\r\n    return class FragmentLoader extends FragmentLoaderBase {\r\n      constructor(config: HlsConfig) {\r\n        super(config, core);\r\n      }\r\n\r\n      static getEngine() {\r\n        return engine;\r\n      }\r\n    };\r\n  }\r\n\r\n  private createPlaylistLoaderClass() {\r\n    const engine = this;\r\n    return class PlaylistLoader extends PlaylistLoaderBase {\r\n      constructor(config: HlsConfig) {\r\n        super(config);\r\n        engine.initHlsEvents();\r\n      }\r\n    };\r\n  }\r\n}"],"names":["Utils.getByteRange","Utils.getSegmentRuntimeId","CoreRequestError","debug","Core"],"mappings":"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"}