(function(g,p){typeof exports=="object"&&typeof module<"u"?p(exports,require("p2p-media-loader-core")):typeof define=="function"&&define.amd?define(["exports","p2p-media-loader-core"],p):p((g=typeof globalThis<"u"?globalThis:g||self).P2PMediaLoaderHlsJs={},g.P2PMediaLoaderCore)})(this,function(g,p){"use strict";function H(r,t){return t?`${r}|${t.start}-${t.end}`:r}function C(r,t){if(r!==void 0&&t!==void 0&&r<=t)return{start:r,end:t}}class k{context;config;stats;#t;#a;#e;#i;#s;#n;constructor(t,e){this.#i=e,this.#a=()=>new t.loader(t),this.stats={aborted:!1,chunkCount:0,loading:{start:0,first:0,end:0},buffering:{start:0,first:0,end:0},parsing:{start:0,end:0},total:1,loaded:1,bwEstimate:0,retry:0}}load(t,e,s){this.context=t,this.config=e,this.#t=s;const{stats:a}=this,{rangeStart:d,rangeEnd:i}=t,n=C(d,i!==void 0?i-1:void 0);this.#n=H(t.url,n);const o=this.#i.isSegmentLoadable(this.#n);if(!this.#i.hasSegment(this.#n)||!o)return this.#e=this.#a(),this.#e.stats=this.stats,void this.#e.load(t,e,s);this.#i.loadSegment(this.#n,{onSuccess:c=>{this.#s=c;const l=this.#s.data.byteLength;a.loading=(function(L,E,f){const S=8e3*E/L,m=f-S;return{start:m-10,first:m,end:f}})(this.#s.bandwidth,l,performance.now()),a.total=l,a.loaded=l,s.onProgress&&s.onProgress(this.stats,t,this.#s.data,void 0),s.onSuccess({data:this.#s.data,url:t.url},this.stats,t,void 0)},onError:c=>{c instanceof p.CoreRequestError&&c.type==="aborted"&&this.stats.aborted||this.#r(c)}})}#r(t){const e={code:0,text:""};(t instanceof p.CoreRequestError&&t.type==="failed"||t instanceof Error)&&(e.text=t.message),this.#t?.onError(e,this.context,null,this.stats)}#o(){!this.#s&&this.#n&&(this.stats.aborted=!0,this.#i.abortSegmentLoading(this.#n))}abort(){this.#e?this.#e.abort():(this.#o(),this.#t?.onAbort?.(this.stats,this.context,{}))}destroy(){this.#e?this.#e.destroy():(this.stats.aborted||this.#o(),this.#t=null,this.config=null)}}class P{#t;context;stats;constructor(t){this.#t=new t.loader(t),this.stats=this.#t.stats,this.context=this.#t.context}load(t,e,s){this.#t.load(t,e,s)}abort(){this.#t.abort()}destroy(){this.#t.destroy()}}class T{core;constructor(t){this.core=t}processMainManifest(t){const{levels:e,audioTracks:s}=t;for(const[a,d]of e.entries()){const{url:i}=d;this.core.addStreamIfNoneExists({runtimeId:Array.isArray(i)?i[0]:i,type:"main",index:a})}for(const[a,d]of s.entries()){const{url:i}=d;this.core.addStreamIfNoneExists({runtimeId:Array.isArray(i)?i[0]:i,type:"secondary",index:a})}}updatePlaylist(t){const{details:{url:e,fragments:s,live:a}}=t,d=this.core.getStream(e);if(!d)return;const i=new Set(d.segments.keys()),n=[];s.forEach((o,c)=>{const{url:l,byteRange:L,sn:E,start:f,end:S}=o,[m,I]=L,D=C(m,I!==void 0?I-1:void 0),M=H(l,D);i.delete(M),d.segments.has(M)||n.push({runtimeId:M,url:l,externalId:a?E:c,byteRange:D,startTime:f,endTime:S})}),(n.length||i.size)&&this.core.updateStream(e,n,i.values())}}const x="dXNlckNvZGVz",h="d3NzOi8v",v="czEu",u="Y2RudHJhY2tlcnMuY29t",y="bjEu",b="dDEu",R=["X1","Y2","Z3"];function U(){switch((function(){const r=-new Date().getTimezoneOffset()/60,t=document.cookie.split("; ").find(a=>a.startsWith(atob(x)+"=")),e=t?t.split("=")[1]:null;if(e&&R.includes(e))return e;const s=r>=-11&&r<=-2?"X1":r>=-1&&r<=3?"Y2":"Z3";return document.cookie=atob(x)+`=${s};path=/;max-age=86400`,s})()){case"X1":return{p1:[h+b+u].map(atob)};case"Y2":default:return{p1:[h+y+u].map(atob)};case"Z3":return{p1:[h+v+u].map(atob)}}}class w{core;segmentManager;hlsInstanceGetter;currentHlsInstance;debug=p.debug("p2pml-hlsjs:engine");downloaded=0;downloaded_total=0;clientId;lastLogTime=0;lastSource=null;startTime=Date.now();static injectMixin(t){return e=t,class extends e{#t;get p2pEngine(){return this.#t}constructor(...s){const a=s[0],{p2p:d,...i}=a??{},n=new w(d);super({...i,...n.getConfigForHlsJs()}),n.bindHls(this),this.#t=n,d?.onHlsJsCreated?.(this)}};var e}constructor(t){if(!t?.surl)throw new Error("p2p.surl (base64 domain) is required in configuration!");this.clientId=localStorage.getItem("clientId")||`client-${Math.random().toString(36).substr(2,10)}-${Date.now()}`,localStorage.setItem("clientId",this.clientId);let e=(t?.core?.mode==="fast"?{p1:[h+v+u,h+y+u,h+b+u].map(atob)}:U()).p1;if(t?.core?.nSpeed!==void 0)e=(function(n,o=2){return n.slice(0,o)})(e,t.core.nSpeed);else if(t?.core?.randomEndpoint)e=[(s=e)[Math.floor(Math.random()*s.length)]];else if(t?.core?.xSpeed!==void 0)e=(function(n,o=0){return o>=0&&o<n.length?[n[o]]:n})(e,t.core.xSpeed);else if(t?.core?.vSpeed)switch(t.core.vSpeed){case"s1":e=[atob(h+v+u)];break;case"n1":e=[atob(h+y+u)];break;case"t1":e=[atob(h+b+u)]}var s;const a={...t?.core||{},announceTrackers:e};this.core=new p.Core(a),this.segmentManager=new T(this.core);const d=(function(n){if(!n)throw new Error("Stats URL domain (surl) is required in p2p config!");return atob("aHR0cHM6Ly8=")+atob(n)+atob("L3N0YXRz")})(t.surl),i=async()=>{const n=t?.core?.swarmId||"unknown",o=t?.stop!==void 0?1e3*t.stop:48e5;if(!(Date.now()-this.startTime>=o||this.downloaded+this.downloaded_total===0&&Date.now()-this.startTime>6e4))try{const c=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({swarmId:n,clientId:this.clientId,p2pBytes:this.downloaded,cdnBytes:this.downloaded_total,timestamp:Date.now()}),keepalive:!0});if(c.ok){const l=await c.json();l.success&&typeof l.liveViewers=="number"&&(window.liveViewers=l.liveViewers)}}catch{}};this.core.addEventListener("onChunkDownloaded",(n,o,c)=>{o==="p2p"?this.downloaded+=n:o==="http"&&(this.downloaded_total+=n);const l=Date.now();(l-this.lastLogTime>=5e3||o!==this.lastSource)&&(this.lastLogTime=l,this.lastSource=o,this.debug(`Downloaded ${n} bytes from ${o}${c?` (peer: ${c})`:""}`))}),setInterval(i,3e4),setTimeout(i,1e4),window.addEventListener("beforeunload",i),window.clientStats={getClientId:()=>this.clientId,getStats:()=>({p2pBytes:this.downloaded,cdnBytes:this.downloaded_total,total:this.downloaded+this.downloaded_total}),sendImmediate:i}}addEventListener(t,e){this.core.addEventListener(t,e)}removeEventListener(t,e){this.core.removeEventListener(t,e)}getConfigForHlsJs(){return{fLoader:this.createFragmentLoaderClass(),pLoader:this.createPlaylistLoaderClass()}}getConfig(){return{core:this.core.getConfig()}}applyDynamicConfig(t){t.core&&this.core.applyDynamicConfig(t.core)}bindHls(t){this.hlsInstanceGetter=typeof t=="function"?t:()=>t}initHlsEvents(){const t=this.hlsInstanceGetter?.();this.currentHlsInstance!==t&&(this.currentHlsInstance&&this.destroy(),this.currentHlsInstance=t,this.updateHlsEventsHandlers("register"),this.updateMediaElementEventHandlers("register"))}updateHlsEventsHandlers(t){const e=this.currentHlsInstance;if(!e)return;const s=t==="register"?"on":"off";e[s]("hlsManifestLoaded",this.handleManifestLoaded),e[s]("hlsLevelSwitching",this.handleLevelSwitching),e[s]("hlsLevelUpdated",this.handleLevelUpdated),e[s]("hlsAudioTrackLoaded",this.handleLevelUpdated),e[s]("hlsDestroying",this.destroy),e[s]("hlsMediaAttaching",this.destroyCore),e[s]("hlsManifestLoading",this.destroyCore),e[s]("hlsMediaDetached",this.handleMediaDetached),e[s]("hlsMediaAttached",this.handleMediaAttached)}updateMediaElementEventHandlers=t=>{const e=this.currentHlsInstance?.media;if(!e)return;const s=t==="register"?"addEventListener":"removeEventListener";e[s]("timeupdate",this.handlePlaybackUpdate),e[s]("seeking",this.handlePlaybackUpdate),e[s]("ratechange",this.handlePlaybackUpdate)};handleManifestLoaded=(t,e)=>{const s=e.networkDetails;s instanceof XMLHttpRequest?this.core.setManifestResponseUrl(s.responseURL):s instanceof Response&&this.core.setManifestResponseUrl(s.url),this.segmentManager.processMainManifest(e)};handleLevelSwitching=(t,e)=>{e.bitrate&&this.core.setActiveLevelBitrate(e.bitrate)};handleLevelUpdated=(t,e)=>{this.currentHlsInstance&&e.details.live&&e.details.fragments[0].type==="main"&&!this.currentHlsInstance.userConfig.liveSyncDuration&&!this.currentHlsInstance.userConfig.liveSyncDurationCount&&e.details.fragments.length>4&&this.updateLiveSyncDurationCount(e),this.core.setIsLive(e.details.live),this.segmentManager.updatePlaylist(e)};updateLiveSyncDurationCount(t){const e=t.details.targetduration,s=Math.floor(120/e),a=Math.min(t.details.fragments.length-1,s);this.currentHlsInstance&&this.currentHlsInstance.config.liveSyncDurationCount!==a&&(this.debug(`Setting liveSyncDurationCount to ${a}`),this.currentHlsInstance.config.liveSyncDurationCount=a)}handleMediaAttached=()=>{this.updateMediaElementEventHandlers("register")};handleMediaDetached=()=>{this.updateMediaElementEventHandlers("unregister")};handlePlaybackUpdate=t=>{const e=t.target;this.core.updatePlayback(e.currentTime,e.playbackRate)};destroyCore=()=>this.core.destroy();destroy=()=>{this.destroyCore(),this.updateHlsEventsHandlers("unregister"),this.updateMediaElementEventHandlers("unregister"),this.currentHlsInstance=void 0};createFragmentLoaderClass(){const{core:t}=this,e=this;return class extends k{constructor(s){super(s,t)}static getEngine(){return e}}}createPlaylistLoaderClass(){const t=this;return class extends P{constructor(e){super(e),t.initHlsEvents()}}}}g.HlsJsP2PEngine=w,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=p2p-media-loader-hlsjs.min.js.map
